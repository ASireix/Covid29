<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <script src="cluster/leaflet.markercluster-src.js"></script>
    <link rel="stylesheet" href="angular-md/angular-material.css">
    <link rel="stylesheet" href="cluster/MarkerCluster.css" />
    <link rel="stylesheet" href="cluster/MarkerCluster.Default.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.js"></script>
    <script src="leafletui/ui-leaflet.min.js"></script>
    <script src="angular/angular-simple-logger.js"></script>
    <script src="angular-md/angular-material.js"></script>
    <script src="angular-an/angular-animate.js"></script>
    <script src="angular-ar/angular-aria.js"></script>
    <script src="angular-sa/angular-sanitize.js"></script>
    <script src="angular-ro/angular-ui-router.js"></script>
    <!--Chart js-->
    <script src="angular-ch/chart.min.js"></script>
    <script src="angular-ach/angular-chart.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
    <link rel="icon" href="ressources/icon2.png"/>




    <style>
        body {
            height: 100%;
        }

        html,
        body {
            background: transparent;
        }

        .navBardemoBasicUsage md-content .ext-content {
            padding: 50px;
            margin: 20px;
            background-color: #FFF2E0;
        }

        #leaflet-map {
            margin-left: 10px;
            height: 600px;
            width: 85vh;
        }

        .md-display-3 {
            text-align: center;
            width: 100%;
            color: blue;
            margin-bottom: 50px;

        }

        .topTitle {
            background-color: white;
            margin-bottom: 50px;
            border: solid;
        }

        .rightInfo {
            margin-right: 10px;
        }

        .ext-content {
            padding: 5px;
            margin: 20px;
        }

        .big-content {
            margin-bottom: 20px;
        }
    </style>
    <title>Alerte Covid29</title>

</head>

<body ng-app="angularApp" ng-controller="ctrl"
    ng-style="{'background-image':'url(ressources/background.jpg)','background-repeat': 'no-repeat', 'background-size':'3000px 3000px'}">


    <div layout="column">
        <div class="topTitle" flex="">
            <h1 class="md-display-3">Bienvenue</h1>
        </div>
        <div class="big-content" flex="">
            <div layout="row">

                <div class="leftMap" flex="">
                    <div layout="column">
                        <div flex="">
                            <leaflet id="leaflet-map" markers="markers" center="center"></leaflet>
                        </div>
                        <div flex="">
                        </div>
                    </div>

                </div>
                <div class="rightInfo" flex="">

                    <md-content class="md-padding">
                        <md-nav-bar md-no-ink-bar="disableInkBar" md-selected-nav-item="currentItem"
                            nav-bar-aria-label="navigation links">
                            <!-- mv nav sref = lien vers une route définie dans app config en bas -->
                            <md-nav-item md-nav-sref="aide" name="aide">
                                Info et aide
                            </md-nav-item>
                            <md-nav-item md-nav-sref="formule" name="form">
                                Formulaire
                            </md-nav-item>
                            <md-nav-item md-nav-sref="stat" name="stat">
                                Statistique
                            </md-nav-item>
                            <md-nav-item md-nav-sref="mention" name="mention">
                                Mentions légales
                            </md-nav-item>

                        </md-nav-bar>

                        <!--<div class="ext-content" ng-bind-html=currentExt>

                        </div>!-->
                        <ui-view></ui-view>
                    </md-content>
                </div>
            </div>
        </div>
    </div>



    <script type="text/javascript">

        var app = angular.module("angularApp", ['ngMaterial', 'ui-leaflet', 'ngSanitize', 'ui.router', 'chart.js']);

        app.factory('dataInfo', function ($http) {
            return $http.get('ressources/dataCenter.json');
        });

        app.factory('reviewInfo', function ($http) {
            return $http.get('ressources/review.json')
        });

        app.factory('formUp', function () {
            var factory = {};
            var id = "inconnu";
            factory.setSite = function (site) {
                id = site;
            }

            factory.getSite = function () {
                return id;
            }
            return factory;

        });

        app.controller("ctrl", ["$scope", "$compile", "$state", "dataInfo", "leafletData", "formUp", "$timeout", function ($scope, $compile, $state, dataInfo, leafletData, formUp, $timeout) {

            angular.extend($scope, {
                center: {
                    lat: 46.095,
                    lng: 2.823,
                    zoom: 6
                },
                markers: {}


            });

            $scope.dataCenter = [];

            $timeout(function () {
                $state.go('aide')
            });


            $scope.currentItem = 'aide';


            $scope.handleClick = function (data) {
                $scope.clicked();
                $scope.formUpdate(data);
            }

            $scope.clicked = function (lieu) {
                if ($state.current.name == 'aide' || $state.current.name == 'mention') {
                    $state.go('formule');
                    $scope.currentItem = 'form';
                }else{
                    $state.reload();
                }

                //console.log($scope.currentItem);
            }

            $scope.formUpdate = function (data) {
                //console.log($scope.dataCenter[data].rs);
                formUp.setSite($scope.dataCenter[data].id);
                $scope.currentSelectedSite = $scope.dataCenter[data].rs;
                //console.log(formUp.getSite());
            }

            dataInfo.then(function (response) {

                var marqueurs = L.markerClusterGroup();

                $scope.dataCenter = response.data;


                var icontrobien = L.icon({
                    iconUrl: 'ressources/icon2.png',

                });
                //console.log("longjrnjgk " + response.data.length)
                for (var i = 0; i < response.data.length; i++) {

                    //console.log(response.data[i].latitude);
                    //console.log(response.data[i].longitude);
                    if (response.data[i].latitude != null) {
                        var html = '<div>' +
                            '<h1>' + response.data[i].rs + '</h1>' +
                            '<h3>' + response.data[i].adresse + '</h3>' +
                            '<md-button class="md-raised md-primary" ng-click="handleClick(' + i + ')">Sélectionner ce centre</md-button>' +
                            '</div>',

                            linkFunction = $compile(angular.element(html)),
                            newScope = $scope.$new();

                        var marker = new L.marker([response.data[i].latitude, response.data[i].longitude], { icon: icontrobien });
                        let popup = L.popup({ autoClose: true, keepInView: true }).setContent(linkFunction(newScope)[0]);
                        marker.bindPopup(popup);
                        marqueurs.addLayer(marker);

                        leafletData.getMap("leaflet-map").then(function (map) {
                            map.addLayer(marqueurs);

                        });
                    }



                }

                /*.catch(function (err) {
                    console.log("Oups", err);
                });*/
            });

            //console.log("papapara");




        }]);

        app.controller("formCtrl", ["$scope", "$http", "$state", "$window", "reviewInfo", "formUp", function ($scope, $http, $state, $window, reviewInfo, formUp) {

            $scope.selected = function () {
                return formUp.getSite() != "inconnu";
            }

            reviewInfo.then(function (response) {
                $scope.review = response.data;
            });

            $scope.getFormulaire = function (user, form) {

                var data = {
                    siteId: [formUp.getSite()],
                    prenom: user.prenom,
                    age: user.age,
                    sexe: user.sexe,
                    dateT: user.dateT,
                    dateR: user.dateR,
                    typeTest: user.resulTest,
                    tpsAttente: user.attente,
                    priseCharge: user.prisecharge,
                    com: user.commentaire
                };

                $scope.review.push(data)
                //console.log($scope.review);
                $http.post("/", $scope.review);
                window.location.reload();
            }

        }]);

        app.controller("statCtrl", ["$scope", "$http", "reviewInfo", "formUp", function ($scope, $http, reviewInfo, formUp) {

            $scope.selected = function () {
                return formUp.getSite() != "inconnu";
            }

            reviewInfo.then(function (response) {
                var bigData = response.data;
                var nowSite = formUp.getSite();;
                var actdata = [];
                if (nowSite != "inconnu") {
                    for (var i = 0; i < response.data.length; i++) {
                        if (response.data[i].siteId == nowSite) {
                            actdata.push(response.data[i]);
                        }
                    }

                }

                //attdata
                var tab1 = [[0], [0], [0], [0], [0]];
                //qualdata
                var tab2 = [[0], [0], [0], [0], [0]];
                //timedata
                var timedata = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                //agedata
                agedata = [0, 0, 0, 0, 0, 0];
                //deldata
                var deldata = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

                for (var i = 0; i < actdata.length; i++) {
                    tab1[parseInt(actdata[i].tpsAttente) - 1][0] += 1;
                    tab2[parseInt(actdata[i].priseCharge) - 1][0] += 1;

                    timedata[(12 * (parseInt((actdata[i].dateT).substring(0, 4)) - 2020)) + (parseInt((actdata[i].dateT).substring(5, 7))) - 1] += 1;

                    delai = parseInt((actdata[i].dateR).substring(8, 10)) - parseInt((actdata[i].dateT).substring(8, 10));
                    console.log(delai);
                    if (delai < 1) {
                        month = (parseInt((actdata[i].dateT).substring(5, 7)))
                        if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) {
                            delai += 31;
                        } else if (month == 2) {
                            if (parseInt((actdata[i].dateR).substring(8, 10)) == 2020) {
                                delai += 29;
                            } else {
                                delai += 28;
                            }
                        } else {
                            delai += 30;
                        }
                    }
                    if (delai >= 30) {
                        delai = 30;
                    }
                    console.log(delai);
                    deldata[delai - 1] += 1;

                    if (parseInt(actdata[i].age) < 18) {
                        agedata[0] += 1;
                    } else if (parseInt(actdata[i].age) < 25) {
                        agedata[1] += 1;
                    } else if (parseInt(actdata[i].age) < 35) {
                        agedata[2] += 1;
                    } else if (parseInt(actdata[i].age) < 45) {
                        agedata[3] += 1;
                    } else if (parseInt(actdata[i].age) < 60) {
                        agedata[4] += 1;
                    } else {
                        agedata[5] += 1;
                    }
                }
                console.log(deldata);
                attdata = []
                for (var i = 0; i < 5; i++) {
                    attdata.push(tab1[i][0]);
                }

                qualdata = [];
                for (var i = 0; i < 5; i++) {
                    qualdata.push(tab2[i][0]);
                }

                $scope.attdata = attdata;
                $scope.qualdata = qualdata;
                $scope.agedata = agedata;
                $scope.timedata = timedata;
                $scope.deldata = deldata;
            });

            $scope.labels = ['Janvier 2020', 'Fevrier 2020', 'Mars 2020', 'Avril 2020', 'Mai 2020', 'Juin 2020', 'Juillet 2020', 'Août 2020', 'Septembre 2020', 'Octobre 2020', 'Novembre 2020', 'Decembre 2020', 'Janvier 2021', 'Fevrier 2021', 'Mars 2021', 'Avril 2021', 'Mai 2021'];
            $scope.series = ['Series A', 'Series B'];
            $scope.labelage = ['Moins de 18 ans', 'Entre 18 et 25 ans', 'Entre 25 et 35 ans', 'Entre 35 et 45 ans', 'Entre 45 et 60 ans', '60+'];
            $scope.labelrating = ['1', '2', '3', '4', '5'];
            $scope.labeldays = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '25', '30+']
        }]);


        app.config(function ($stateProvider) {

            var formuleState = {
                name: 'formule',
                url: '/form',
                templateUrl: 'ressources/form.html',
                controller: 'formCtrl'
            }

            var statState = {
                name: 'stat',
                url: '/stat',
                templateUrl: 'ressources/stats.html',
                controller: 'statCtrl',
                reload: true
            }

            var mentionState = {
                name: 'mention',
                url: '/mention',
                templateUrl: 'ressources/mention.html'

            }

            var aideState = {
                name: 'aide',
                url: '/aide',
                templateUrl: 'ressources/aide.html'
            }



            $stateProvider.state(formuleState);
            $stateProvider.state(statState);
            $stateProvider.state(mentionState);
            $stateProvider.state(aideState);

        });

    </script>


</body>

</html>








































<!-- Bonsoir paris, singe élu président 2021 -->